<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale.1.0">
  <title>AI 音楽カタログ補完ツール</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    body, html {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f8f7f7;
    }
    .btn-primary {
      display: inline-block; font-weight: 500; padding: 0.75rem 1.5rem; border: 2px solid #1a1a1a;
      background-color: transparent; color: #1a1a1a; text-decoration: none;
      transition: all 0.2s ease-in-out; cursor: pointer;
    }
    .btn-primary:hover, .btn-primary:focus { background-color: #1a1a1a; color: #f8f7f7; }
    .btn-primary.disabled {
      border-color: #9ca3af; color: #9ca3af; background-color: #f3f4f6; cursor: not-allowed;
    }
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type=file] {
      position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;
    }
    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid #343a40; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* プログレスバーはサーバー側で処理するため簡易化 (進捗は取らない) */
  </style>
</head>
<body class="text-gray-900">

  <div class="container mx-auto max-w-2xl min-h-screen flex items-center justify-center p-6">
    <div class="w-full bg-white shadow-sm border border-gray-200 p-8 text-center">
      
      <h1 class="text-2xl font-bold mb-4">AI 音楽カタログ補完ツール</h1>
      <p class="text-gray-600 mb-8">
        CSVファイルの商品名を元に、不足している情報をAIが自動補完します。
      </p>

      <div id="app-state-container">

        <div id="state-wait">
          <div class="file-input-wrapper btn-primary" id="file-btn-wrapper">
            <span>CSVファイルを選択</span>
            <input type="file" id="csv-file-input" accept=".csv" onchange="handleFileSelect(event)">
          </div>
          <p class="text-sm text-gray-500 mt-4">
            ※最大処理件数は1,000件です。
          </p>
        </div>

        <div id="state-loading" class="hidden">
          <div class="flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p id="loading-text" class="text-lg font-medium text-gray-700">サーバーでAIがデータを解析中です...</p>
            <p class="text-gray-500">処理が完了すると自動でダウンロードされます。しばらくお待ちください。</p>
          </div>
        </div>

        </div>

      <div id="error-message" class="text-red-600 font-medium mt-6"></div>

    </div>
  </div>

  <script>
    // --- UI要素 ---
    const stateWait = document.getElementById('state-wait');
    const stateLoading = document.getElementById('state-loading');
    const errorMessage = document.getElementById('error-message');
    const fileInput = document.getElementById('csv-file-input');
    const fileBtnWrapper = document.getElementById('file-btn-wrapper');

    // --- UI状態管理 ---
    function setUIState(state) {
      errorMessage.textContent = '';
      if (state === 'wait') {
        stateWait.classList.remove('hidden');
        stateLoading.classList.add('hidden');
        fileInput.value = ''; // ファイル選択をリセット
        fileBtnWrapper.classList.remove('disabled'); // ボタンを有効化
      } else if (state === 'loading') {
        stateWait.classList.add('hidden');
        stateLoading.classList.remove('hidden');
        fileBtnWrapper.classList.add('disabled'); // ボタンを無効化
      }
    }

    // --- エラー表示 ---
    function showError(message) {
      console.error(`[Error] ${message}`);
      errorMessage.textContent = message;
      setUIState('wait');
    }

    // --- ファイル選択＆アップロード ---
    async function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      console.log('[Upload] File selected. Starting upload to server...');
      setUIState('loading');

      const formData = new FormData();
      formData.append('csv-file', file); // 'csv-file' は server.js の upload.single() の名前と一致させる

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          // サーバーからのエラーレスポンス (JSON形式) をパース
          const errorData = await response.json();
          console.error('[Upload Error] Server returned:', response.status, errorData.error);
          showError(`サーバーエラー: ${errorData.error || response.statusText}`);
          return;
        }

        // 成功時: サーバーはCSVファイルを返してくる
        console.log('[Upload OK] Server returned processed file. Triggering download...');
        
        // レスポンスからblob (バイナリデータ) を取得
        const blob = await response.blob();
        
        // ダウンロード処理
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        
        // ヘッダーからファイル名を取得しようと試みる (なければデフォルト)
        const disposition = response.headers.get('content-disposition');
        let filename = 'processed_catalog.csv'; // デフォルト
        if (disposition && disposition.indexOf('attachment') !== -1) {
          const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
          const matches = filenameRegex.exec(disposition);
          if (matches != null && matches[1]) {
            filename = matches[1].replace(/['"]/g, '');
          }
        }
        
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        
        // クリーンアップ
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
        console.log('[Upload] Download triggered. Resetting UI.');
        
        setUIState('wait'); // 待機状態に戻る

      } catch (error) {
        console.error('[Upload Error] Network or fetch error:', error);
        showError(`通信エラーが発生しました: ${error.message}`);
      }
    }
  </script>

</body>
</html>
